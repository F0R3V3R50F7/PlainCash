<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PlainCash</title>
<style>
:root {
  --system-blue: #0A84FF;
  --system-green: #30D158;
  --system-orange: #FF9F0A;
  --system-red: #FF453A;
  --system-purple: #BF5AF2;
  --system-gray: #8E8E93;
  --system-gray2: #636366;
  --system-gray3: #48484A;
  --system-gray4: #3A3A3C;
  --system-gray5: #2C2C2E;
  --system-gray6: #1C1C1E;
  
  --bg-primary: #000000;
  --bg-secondary: #1C1C1E;
  --bg-tertiary: #2C2C2E;
  --bg-elevated: #1C1C1E;
  --bg-card: rgba(255,255,255,0.05);
  
  --text-primary: #FFFFFF;
  --text-secondary: #EBEBF5;
  --text-tertiary: #EBEBF599;
  --text-quaternary: #EBEBF54D;
  
  --separator: #38383A;
  --fill-primary: #787880;
  --fill-secondary: #7878805E;
  --fill-tertiary: #7676803D;
  --fill-quaternary: #7676802E;
  
  --accent: var(--system-blue);
  --success: var(--system-green);
  --warning: var(--system-orange);
  --danger: var(--system-red);
  
  --blur: blur(20px);
  --radius-small: 10px;
  --radius-medium: 14px;
  --radius-large: 18px;
}

* { 
  box-sizing: border-box; 
  -webkit-font-smoothing: antialiased;
}

html, body { 
  height: 100%; 
  margin: 0; 
  font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Helvetica Neue', sans-serif; 
  background: var(--bg-primary); 
  color: var(--text-primary); 
  overflow: hidden;
}

.app { 
  width: 100%; 
  height: 100vh; 
  display: flex; 
  flex-direction: column; 
  background: var(--bg-primary); 
  margin: 0 auto; 
  position: relative; 
  overflow: hidden; 
}

/* iOS-style buttons */
.btn { 
  background: var(--fill-secondary); 
  border-radius: var(--radius-medium); 
  padding: 10px 16px; 
  color: var(--system-blue); 
  border: none; 
  cursor: pointer; 
  font-weight: 600; 
  font-size: 17px; 
  transition: all 0.2s; 
  backdrop-filter: var(--blur);
  display: inline-flex;
  align-items: center;
  justify-content: center;
  min-height: 44px;
}

.btn:hover { 
  background: var(--fill-tertiary); 
}

.btn.primary { 
  background: var(--system-blue); 
  color: white; 
  box-shadow: 0 4px 12px rgba(10, 132, 255, 0.3); 
}

.btn.primary:hover { 
  background: #007AFF; 
  transform: translateY(-1px);
  box-shadow: 0 6px 16px rgba(10, 132, 255, 0.4);
}

.btn.secondary { 
  background: var(--fill-tertiary); 
  color: var(--text-primary); 
}

.btn.secondary:hover { 
  background: var(--fill-secondary); 
}

.btn.danger { 
  background: var(--system-red); 
  color: white; 
}

.btn.danger:hover { 
  background: #FF3B30; 
}

/* Dashboard layout */
.dashboard {
  display: none;
  width: 100%;
  height: 100vh;
  flex-direction: column;
}

.dashboard.active {
  display: flex;
}

/* POS Dashboard Layout */
.pos-main { 
  display: flex; 
  flex: 1; 
  overflow: hidden; 
  min-height: 0; 
  height: 100%; 
}

.pos-left-panel { 
  width: 65%; 
  display: flex; 
  flex-direction: column; 
  background: var(--bg-primary); 
  position: relative; 
  overflow: hidden; 
}

.pos-right-panel { 
  width: 35%; 
  display: flex; 
  flex-direction: column; 
  background: var(--bg-secondary); 
  overflow-y: auto; 
  border-left: 1px solid var(--separator);
}

/* Accounts Dashboard Layout */
.accounts-main {
  display: flex;
  flex: 1;
  overflow: hidden;
  min-height: 0;
  height: 100%;
}

.accounts-left-panel {
  width: 60%;
  display: flex;
  flex-direction: column;
  background: var(--bg-primary);
  position: relative;
  overflow: hidden;
}

.accounts-right-panel {
  width: 40%;
  display: flex;
  flex-direction: column;
  background: var(--bg-secondary);
  overflow-y: auto;
  border-left: 1px solid var(--separator);
}

.products-section { 
  flex: 1; 
  display: flex; 
  flex-direction: column; 
  overflow: hidden; 
  position: relative; 
}

.catalog-container { 
  flex: 1; 
  overflow-y: auto; 
  padding: 16px; 
}

.checkout-section { 
  background: var(--bg-elevated); 
  border-top: 1px solid var(--separator); 
  padding: 16px; 
  backdrop-filter: var(--blur);
}

/* iOS-style utility bar */
.utility-bar { 
  display: flex; 
  align-items: center; 
  justify-content: space-between; 
  gap: 0; 
  margin-bottom: 16px; 
  background: var(--bg-card); 
  border-radius: var(--radius-large); 
  border: 1px solid var(--separator); 
  padding: 8px; 
  overflow: hidden; 
  backdrop-filter: var(--blur);
}

.utility-item { 
  display: flex; 
  flex-direction: column; 
  align-items: center; 
  padding: 12px 8px; 
  cursor: pointer; 
  transition: all 0.2s; 
  flex: 1; 
  min-height: 60px; 
  justify-content: center; 
  position: relative; 
  border-radius: var(--radius-medium);
}

.utility-item:not(:last-child)::after { 
  content: ''; 
  position: absolute; 
  right: 0; 
  top: 25%; 
  height: 50%; 
  width: 1px; 
  background: var(--separator); 
}

.utility-item:hover { 
  background: var(--fill-quaternary); 
}

.utility-icon { 
  font-size: 24px; 
  margin-bottom: 4px; 
  width: 40px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 8px;
  background: var(--fill-tertiary);
}

.utility-label { 
  font-size: 12px; 
  font-weight: 600; 
  color: var(--text-secondary); 
  line-height: 1.1; 
  text-align: center; 
}

.panel-section { 
  padding: 20px; 
  border-bottom: 1px solid var(--separator); 
}

.panel-section:last-child { 
  border-bottom: none; 
}

h2 { 
  margin: 0 0 16px 0; 
  color: var(--text-primary); 
  font-weight: 700; 
  font-size: 22px; 
}

h3 { 
  margin: 0 0 12px 0; 
  color: var(--text-primary); 
  font-weight: 600; 
  font-size: 17px; 
}

/* Catalog grid */
.catalog { 
  display: grid; 
  grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); 
  gap: 12px; 
  align-content: start; 
}

.product { 
  display: flex; 
  flex-direction: column; 
  padding: 16px; 
  border-radius: var(--radius-large); 
  background: var(--bg-card); 
  border: 1px solid var(--separator); 
  transition: all 0.2s; 
  cursor: pointer; 
  position: relative; 
  height: 140px; 
  backdrop-filter: var(--blur);
}

.product:hover { 
  border-color: var(--system-blue); 
  transform: translateY(-2px);
  box-shadow: 0 8px 20px rgba(0,0,0,0.3); 
}

.thumb { 
  width: 100%; 
  height: 60px; 
  border-radius: var(--radius-medium); 
  background: linear-gradient(135deg, var(--bg-tertiary), var(--system-gray4)); 
  display: flex; 
  align-items: center; 
  justify-content: center; 
  font-weight: 700; 
  color: var(--text-secondary); 
  margin-bottom: 12px; 
  font-size: 16px; 
  position: relative; 
}

.service .thumb { 
  background: linear-gradient(135deg, var(--system-purple), #8944CF); 
  color: white; 
}

.low-stock-indicator { 
  position: absolute; 
  bottom: 4px; 
  left: 4px; 
  font-size: 14px; 
  color: var(--warning); 
}

.name { 
  font-weight: 600; 
  font-size: 16px; 
  margin-bottom: 4px; 
  white-space: nowrap; 
  overflow: hidden; 
  text-overflow: ellipsis; 
  color: var(--text-primary); 
  line-height: 1.2; 
}

.meta { 
  font-size: 14px; 
  color: var(--text-tertiary); 
  display: flex; 
  justify-content: space-between; 
  line-height: 1.2; 
}

.price { 
  font-weight: 700; 
  color: var(--success); 
  font-size: 14px; 
}

.product-menu { 
  position: absolute; 
  top: 12px; 
  right: 12px; 
  width: 30px; 
  height: 30px; 
  border-radius: var(--radius-small); 
  background: var(--fill-tertiary); 
  display: flex; 
  align-items: center; 
  justify-content: center; 
  cursor: pointer; 
  opacity: 0; 
  transition: opacity 0.2s; 
  font-size: 16px; 
}

.product:hover .product-menu { 
  opacity: 1; 
}

.product-menu:hover { 
  background: var(--fill-secondary); 
}

.product-menu-dots { 
  font-size: 16px; 
  line-height: 1; 
  color: var(--text-secondary); 
}

.menu-dropdown { 
  position: absolute; 
  top: 40px; 
  right: 12px; 
  background: var(--bg-elevated); 
  border: 1px solid var(--separator); 
  border-radius: var(--radius-medium); 
  box-shadow: 0 10px 30px rgba(0,0,0,0.4); 
  z-index: 10; 
  min-width: 140px; 
  overflow: hidden; 
  backdrop-filter: var(--blur);
}

.menu-item { 
  padding: 12px 16px; 
  font-size: 16px; 
  cursor: pointer; 
  transition: background 0.2s; 
  color: var(--text-primary); 
}

.menu-item:hover { 
  background: var(--fill-quaternary); 
}

.menu-item.delete { 
  color: var(--danger); 
}

.add-product { 
  display: flex; 
  flex-direction: column; 
  align-items: center; 
  justify-content: center; 
  padding: 16px; 
  border-radius: var(--radius-large); 
  background: var(--bg-card); 
  border: 2px dashed var(--system-blue); 
  cursor: pointer; 
  height: 140px; 
  transition: all 0.2s; 
  backdrop-filter: var(--blur);
}

.add-product:hover { 
  background: rgba(10, 132, 255, 0.1); 
  transform: translateY(-2px);
}

.add-thumb { 
  width: 40px; 
  height: 40px; 
  border-radius: 50%; 
  background: linear-gradient(135deg, var(--system-blue), #007AFF); 
  display: flex; 
  align-items: center; 
  justify-content: center; 
  font-weight: 700; 
  color: white; 
  font-size: 20px; 
  margin-bottom: 12px; 
}

.cart { 
  overflow-y: auto; 
  border-radius: var(--radius-large); 
  padding: 16px; 
  background: var(--bg-card); 
  border: 1px solid var(--separator); 
  max-height: 180px; 
  margin-bottom: 16px; 
  backdrop-filter: var(--blur);
}

.cart-item { 
  display: flex; 
  justify-content: space-between; 
  align-items: center; 
  padding: 12px 0; 
  border-bottom: 1px dashed var(--separator); 
  font-size: 16px; 
}

.cart-item-info { 
  flex: 1; 
}

.cart-item-actions { 
  display: flex; 
  gap: 8px; 
  align-items: center; 
}

.remove-item { 
  color: var(--danger); 
  background: none; 
  border: none; 
  cursor: pointer; 
  font-size: 20px; 
  padding: 4px 8px; 
  border-radius: var(--radius-small); 
  transition: background 0.2s; 
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.remove-item:hover { 
  background: rgba(255,69,58,0.2); 
}

.cart-footer { 
  display: flex; 
  justify-content: space-between; 
  align-items: center; 
  margin-top: 16px; 
  padding-top: 16px; 
  border-top: 1px solid var(--separator); 
}

.actions { 
  display: flex; 
  gap: 8px; 
}

.ledger { 
  height: 240px; 
  overflow-y: auto; 
  border-radius: var(--radius-large); 
  padding: 16px; 
  background: var(--bg-card); 
  border: 1px solid var(--separator); 
  font-size: 15px; 
  backdrop-filter: var(--blur);
}

table { 
  width: 100%; 
  border-collapse: collapse; 
  font-size: 15px; 
}

th, td { 
  padding: 12px 16px; 
  text-align: left; 
  border-bottom: 1px solid var(--separator); 
  color: var(--text-primary); 
}

th { 
  background: var(--bg-tertiary); 
  position: sticky; 
  top: 0; 
  font-weight: 600; 
  font-size: 15px; 
}

.search { 
  display: flex; 
  gap: 12px; 
  align-items: center; 
  margin-bottom: 20px; 
}

input[type=text], select { 
  padding: 12px 16px; 
  border-radius: var(--radius-medium); 
  border: 1px solid var(--separator); 
  flex: 1; 
  font-size: 17px; 
  background: var(--bg-card); 
  color: var(--text-primary); 
  backdrop-filter: var(--blur);
}

input[type=text]::placeholder { 
  color: var(--text-tertiary); 
}

.small { 
  font-size: 15px; 
  color: var(--text-tertiary); 
}

.chip { 
  display: inline-block; 
  padding: 6px 12px; 
  border-radius: 100px; 
  background: var(--fill-tertiary); 
  font-size: 14px; 
  color: var(--text-primary); 
}

.tax-breakdown, .vat-breakdown { 
  margin-top: 16px; 
  padding: 16px; 
  background: var(--bg-card); 
  border-radius: var(--radius-large); 
  border: 1px solid var(--separator); 
  backdrop-filter: var(--blur);
}

.tax-row, .vat-row { 
  display: flex; 
  justify-content: space-between; 
  margin-bottom: 8px; 
  font-size: 16px; 
  color: var(--text-primary); 
}

.tax-total, .vat-total { 
  font-weight: bold; 
  border-top: 1px solid var(--separator); 
  padding-top: 8px; 
  margin-top: 8px; 
}

.tax-warning { 
  background: rgba(255,159,10,0.2); 
  border: 1px solid var(--warning); 
  border-radius: var(--radius-large); 
  padding: 16px; 
  margin-top: 16px; 
  font-size: 15px; 
  color: var(--text-primary); 
}

/* iOS-style modals */
.modal { 
  display: none; 
  position: fixed; 
  top: 0; 
  left: 0; 
  width: 100%; 
  height: 100%; 
  background: rgba(0,0,0,0.6); 
  z-index: 1000; 
  align-items: center; 
  justify-content: center; 
}

.modal-content { 
  background: var(--bg-elevated); 
  padding: 24px; 
  border-radius: var(--radius-large); 
  width: 480px; 
  max-width: 90%; 
  max-height: 90vh; 
  overflow-y: auto; 
  box-shadow: 0 20px 40px rgba(0,0,0,0.4); 
  position: relative; 
  color: var(--text-primary); 
  backdrop-filter: var(--blur);
  border: 1px solid var(--separator);
}

.modal-close { 
  position: absolute; 
  top: 16px; 
  right: 16px; 
  background: none; 
  border: none; 
  font-size: 24px; 
  cursor: pointer; 
  color: var(--text-tertiary); 
  width: 36px; 
  height: 36px; 
  display: flex; 
  align-items: center; 
  justify-content: center; 
  border-radius: var(--radius-small); 
}

.modal-close:hover { 
  background: var(--fill-quaternary); 
}

.modal-buttons { 
  display: flex; 
  gap: 8px; 
  justify-content: flex-end; 
  margin-top: 20px; 
}

.status-income { 
  color: var(--success); 
}

.status-expense { 
  color: var(--danger); 
}

.compact-form { 
  display: flex; 
  flex-direction: column; 
  gap: 12px; 
}

.form-row { 
  display: flex; 
  gap: 12px; 
}

.form-row > * { 
  flex: 1; 
}

.confirmation-box { 
  margin: 16px 0; 
  padding: 16px; 
  border: 1px solid var(--separator); 
  border-radius: var(--radius-large); 
  background: var(--bg-card); 
}

.confirmation-instruction { 
  font-size: 16px; 
  margin-bottom: 8px; 
  color: var(--text-secondary); 
}

.confirmation-input { 
  width: 100%; 
  padding: 12px 16px; 
  border: 1px solid var(--separator); 
  border-radius: var(--radius-medium); 
  font-family: -apple-system, BlinkMacSystemFont, sans-serif; 
  font-size: 16px; 
  background: var(--bg-card); 
  color: var(--text-primary); 
}

.confirmation-input:focus { 
  outline: none; 
  border-color: var(--system-blue); 
}

.confirmation-input.error { 
  border-color: var(--danger); 
}

.tax-categories { 
  width: 100%; 
  border-collapse: collapse; 
  margin: 16px 0; 
  font-size: 16px; 
}

.tax-categories th, .tax-categories td { 
  padding: 12px 16px; 
  text-align: left; 
  border-bottom: 1px solid var(--separator); 
  color: var(--text-primary); 
}

.tax-categories th { 
  background: var(--bg-tertiary); 
  font-weight: 600; 
}

.tax-rate-input { 
  width: 80px; 
  padding: 8px 12px; 
  border: 1px solid var(--separator); 
  border-radius: var(--radius-medium); 
  text-align: right; 
  background: var(--bg-card); 
  color: var(--text-primary); 
  font-size: 16px; 
}

.tax-description { 
  font-size: 15px; 
  color: var(--text-tertiary); 
  margin-top: 8px; 
}

.analytics-container { 
  display: flex; 
  flex-direction: column; 
  height: 100%; 
  overflow: hidden; 
}

.analytics-chart { 
  flex: 1; 
  display: flex; 
  align-items: center; 
  justify-content: center; 
  margin: 24px 0; 
}

.analytics-stats { 
  display: grid; 
  grid-template-columns: repeat(2, 1fr); 
  gap: 16px; 
  margin-top: 24px; 
}

.stat-card { 
  background: var(--bg-card); 
  border-radius: var(--radius-large); 
  padding: 20px; 
  text-align: center; 
  backdrop-filter: var(--blur);
}

.stat-value { 
  font-size: 28px; 
  font-weight: 700; 
  margin-bottom: 8px; 
  color: var(--text-primary); 
}

.stat-label { 
  font-size: 15px; 
  color: var(--text-tertiary); 
}

/* iOS-style notification */
.notification { 
  position: fixed; 
  top: 60px; 
  right: 20px; 
  background: var(--bg-elevated); 
  border-radius: var(--radius-large); 
  padding: 16px 20px; 
  box-shadow: 0 10px 30px rgba(0,0,0,0.4); 
  border-left: 4px solid var(--system-blue); 
  z-index: 10000; 
  max-width: 320px; 
  display: flex; 
  align-items: center; 
  gap: 12px; 
  backdrop-filter: var(--blur);
  border: 1px solid var(--separator);
}

.notification-icon { 
  font-size: 20px; 
}

.notification-content { 
  flex: 1; 
}

.notification-title { 
  font-weight: 600; 
  margin-bottom: 4px; 
  color: var(--text-primary); 
  font-size: 16px; 
}

.notification-message { 
  font-size: 15px; 
  color: var(--text-secondary); 
}

.notification-close { 
  background: none; 
  border: none; 
  font-size: 20px; 
  cursor: pointer; 
  color: var(--text-tertiary); 
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: var(--radius-small);
}

.notification-close:hover { 
  background: var(--fill-quaternary); 
}

::-webkit-scrollbar { 
  width: 8px; 
}

::-webkit-scrollbar-track { 
  background: var(--bg-secondary); 
  border-radius: 4px; 
}

::-webkit-scrollbar-thumb { 
  background: var(--fill-primary); 
  border-radius: 4px; 
}

::-webkit-scrollbar-thumb:hover { 
  background: var(--system-blue); 
}

.scrollable { 
  overflow-y: auto; 
}

.transactions-section { 
  flex: 1; 
  display: flex; 
  flex-direction: column; 
}

.vat-registration-section { 
  margin-bottom: 20px; 
  padding: 20px; 
  background: var(--bg-card); 
  border-radius: var(--radius-large); 
  border: 1px solid var(--separator); 
  backdrop-filter: var(--blur);
}

.vat-registration-section h4 { 
  margin: 0 0 12px 0; 
  font-size: 17px; 
}

.vat-toggle { 
  display: flex; 
  align-items: center; 
  gap: 12px; 
  margin-bottom: 12px; 
}

.vat-toggle input[type="checkbox"] { 
  margin: 0; 
  width: 20px;
  height: 20px;
}

.vat-toggle label { 
  font-size: 17px; 
  font-weight: 600; 
}

.vat-details { 
  margin-top: 12px; 
}

.vat-threshold-info { 
  font-size: 15px; 
  margin-top: 8px; 
}

.vat-threshold-info strong { 
  color: var(--text-primary); 
}

.transaction-actions { 
  display: flex; 
  gap: 6px; 
}

.transaction-actions button { 
  font-size: 13px; 
  padding: 6px 10px; 
}

/* iOS-style checkbox */
input[type="checkbox"] {
  appearance: none;
  -webkit-appearance: none;
  width: 20px;
  height: 20px;
  border-radius: 6px;
  border: 2px solid var(--system-gray3);
  background: transparent;
  position: relative;
  cursor: pointer;
}

input[type="checkbox"]:checked {
  background: var(--system-blue);
  border-color: var(--system-blue);
}

input[type="checkbox"]:checked::after {
  content: "‚úì";
  position: absolute;
  color: white;
  font-size: 14px;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
}

/* Transaction Timeline */
.transaction-timeline {
  flex: 1;
  overflow-y: auto;
  padding: 16px;
}

.timeline-item {
  display: flex;
  align-items: center;
  padding: 16px;
  border-bottom: 1px solid var(--separator);
}

.timeline-icon {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-right: 16px;
  font-size: 18px;
}

.timeline-icon.income {
  background: rgba(48, 209, 88, 0.2);
  color: var(--system-green);
}

.timeline-icon.expense {
  background: rgba(255, 69, 58, 0.2);
  color: var(--system-red);
}

.timeline-content {
  flex: 1;
}

.timeline-amount {
  font-weight: 600;
  font-size: 17px;
}

.timeline-amount.income {
  color: var(--system-green);
}

.timeline-amount.expense {
  color: var(--system-red);
}

.timeline-date {
  font-size: 14px;
  color: var(--text-tertiary);
  margin-top: 4px;
}

@media (max-width: 1024px) {
  .pos-left-panel, .accounts-left-panel { width: 60%; } 
  .pos-right-panel, .accounts-right-panel { width: 40%; } 
  .btn { font-size: 15px; padding: 8px 14px; } 
  input[type=text], select { font-size: 15px; } 
  .product { height: 130px; } 
  .catalog { grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); } 
  .utility-item { padding: 10px 8px; } 
  .utility-label { font-size: 11px; }
}

@media (max-width: 768px) {
  .pos-left-panel, .accounts-left-panel { width: 55%; } 
  .pos-right-panel, .accounts-right-panel { width: 45%; } 
  .catalog { grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); } 
  .product { height: 120px; padding: 12px; } 
  .name { font-size: 14px; } 
  .meta { font-size: 12px; } 
  .utility-bar { flex-wrap: wrap; } 
  .utility-item { min-width: 70px; padding: 8px 6px; }
}
</style>
</head>
<body>
<div class="app" role="application">
  <!-- POS Dashboard -->
  <div class="dashboard active" id="posDashboard">
    <div class="pos-main">
      <div class="pos-left-panel">
        <div class="panel-section products-section">
          <h2>Services & Products</h2>
          <div class="search">
            <input id="filter" type="text" placeholder="Search services or products‚Ä¶" oninput="renderCatalog()" />
            <div class="chip" id="stockCount">0 items</div>
          </div>
          <div class="catalog-container scrollable">
            <div class="catalog" id="catalog"></div>
          </div>
        </div>
      </div>
      <div class="pos-right-panel">
        <div class="panel-section" style="padding-bottom: 12px;">
          <div class="utility-bar">
            <div class="utility-item" onclick="switchDashboard('posDashboard')">
              <div class="utility-icon">üí≥</div>
              <div class="utility-label">POS</div>
            </div>
            <div class="utility-item" onclick="switchDashboard('accountsDashboard')">
              <div class="utility-icon">üìí</div>
              <div class="utility-label">Accounts</div>
            </div>
            <div class="utility-item" onclick="showAnalytics()">
              <div class="utility-icon">üìà</div>
              <div class="utility-label">Analytics</div>
            </div>
            <div class="utility-item" onclick="showSettings()">
              <div class="utility-icon">‚öôÔ∏è</div>
              <div class="utility-label">Settings</div>
            </div>
            <div class="utility-item" onclick="showUserMenu()">
              <div class="utility-icon">üë§</div>
              <div class="utility-label">User</div>
            </div>
          </div>
        </div>
        <div class="checkout-section">
          <h2>Checkout</h2>
          <div class="cart scrollable" id="cart">
            <div class="small">Cart empty</div>
          </div>
          <div class="cart-footer">
            <div>
              <div class="small">Subtotal: <span id="subtotal">¬£0.00</span></div>
              <div class="small">VAT: <span id="vatTotal">¬£0.00</span></div>
              <div class="small">Total: <strong id="total">¬£0.00</strong></div>
            </div>
            <div class="actions">
              <button class="btn" onclick="clearCart()">Clear All</button>
              <button class="btn primary" onclick="checkout()">Print & Record</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Accounts Dashboard -->
  <div class="dashboard" id="accountsDashboard">
    <div class="accounts-main">
      <div class="accounts-left-panel">
        <div class="panel-section" style="flex: 1; display: flex; flex-direction: column;">
          <h2>Transaction Timeline</h2>
          <div class="transaction-timeline scrollable" id="transactionTimeline">
            <div class="small" style="text-align: center; padding: 40px;">No transactions yet</div>
          </div>
        </div>
      </div>
      <div class="accounts-right-panel">
        <div class="panel-section" style="padding-bottom: 12px;">
          <div class="utility-bar">
            <div class="utility-item" onclick="switchDashboard('posDashboard')">
              <div class="utility-icon">üí≥</div>
              <div class="utility-label">POS</div>
            </div>
            <div class="utility-item" onclick="switchDashboard('accountsDashboard')">
              <div class="utility-icon">üìí</div>
              <div class="utility-label">Accounts</div>
            </div>
            <div class="utility-item" onclick="exportHMRCReport()">
              <div class="utility-icon">üìä</div>
              <div class="utility-label">Report</div>
            </div>
            <div class="utility-item" onclick="showSettings()">
              <div class="utility-icon">‚öôÔ∏è</div>
              <div class="utility-label">Settings</div>
            </div>
            <div class="utility-item" onclick="showUserMenu()">
              <div class="utility-icon">üë§</div>
              <div class="utility-label">User</div>
            </div>
          </div>
        </div>
        <div class="panel-section">
          <h2>Quick Transaction</h2>
          <form id="quickForm" onsubmit="event.preventDefault(); quickAdd();" class="compact-form">
            <div class="form-row">
              <input id="q_amount" type="number" step="0.01" placeholder="Amount" required />
              <select id="q_type">
                <option value="income">Income</option>
                <option value="expense">Expense</option>
              </select>
            </div>
            <div class="form-row">
              <select id="q_cat">
                <option value="">Category</option>
                <option value="Standard Rate">Standard Rate (20%)</option>
                <option value="Reduced Rate">Reduced Rate (5%)</option>
                <option value="Zero Rate">Zero Rate (0%)</option>
                <option value="Exempt">Exempt</option>
                <option value="Outside Scope">Outside Scope</option>
              </select>
              <input id="q_notes" type="text" placeholder="Notes" />
            </div>
            <button class="btn primary" type="submit" style="margin-top: 8px;">Record Transaction</button>
          </form>
        </div>
        <div class="panel-section">
          <h2>VAT Breakdown</h2>
          <div class="vat-breakdown scrollable">
            <div class="vat-row"><span>Standard Rate (20%):</span> <span id="vatStandard">¬£0.00</span></div>
            <div class="vat-row"><span>Reduced Rate (5%):</span> <span id="vatReduced">¬£0.00</span></div>
            <div class="vat-row"><span>Zero Rate (0%):</span> <span id="vatZero">¬£0.00</span></div>
            <div class="vat-row"><span>Exempt:</span> <span id="vatExempt">¬£0.00</span></div>
            <div class="vat-row vat-total"><span>Total VAT Due:</span> <span id="vatDue">¬£0.00</span></div>
          </div>
        </div>
        <div class="panel-section">
          <h2>Income Tax Overview</h2>
          <div class="tax-breakdown scrollable">
            <div class="tax-row"><span>Tax Year:</span> <span id="taxYear">2024-25</span></div>
            <div class="tax-row"><span>Total Income:</span> <span id="totalIncome">¬£0.00</span></div>
            <div class="tax-row"><span>Total Expenses:</span> <span id="totalExpenses">¬£0.00</span></div>
            <div class="tax-row"><span>Taxable Profit:</span> <span id="taxableProfit">¬£0.00</span></div>
            <div class="tax-row"><span>Personal Allowance:</span> <span>¬£12,570.00</span></div>
            <div class="tax-row"><span>Income Tax Due:</span> <span id="incomeTaxDue">¬£0.00</span></div>
            <div class="tax-row"><span>National Insurance:</span> <span id="niDue">¬£0.00</span></div>
            <div class="tax-row tax-total"><span>Total Tax Due:</span> <span id="totalTaxDue">¬£0.00</span></div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ##### MODALS SECTION ##### -->
<div id="addProductModal" class="modal">
  <div class="modal-content">
    <button class="modal-close" onclick="closeAddProductModal()">√ó</button>
    <h3>Add New Service or Product</h3>
    <form id="addProductForm" onsubmit="event.preventDefault(); addNewProduct();" class="compact-form">
      <input type="text" id="newProductName" placeholder="Service or Product Name" required>
      <div class="form-row">
        <input type="number" id="newProductPrice" placeholder="Price" step="0.01" min="0" required>
        <select id="newProductType">
          <option value="product">Product</option>
          <option value="service">Service</option>
        </select>
      </div>
      <div class="form-row" id="stockRow">
        <input type="number" id="newProductStock" placeholder="Stock" min="0" required>
        <input type="text" id="newProductThumb" placeholder="Icon Code (2 letters)" maxlength="2" required>
      </div>
      <div class="form-row">
        <select id="newProductTaxCategory" required>
          <option value="">Select VAT Category</option>
          <option value="Standard Rate">Standard Rate (20%)</option>
          <option value="Reduced Rate">Reduced Rate (5%)</option>
          <option value="Zero Rate">Zero Rate (0%)</option>
          <option value="Exempt">Exempt</option>
          <option value="Outside Scope">Outside Scope</option>
        </select>
      </div>
      <div class="modal-buttons">
        <button type="button" class="btn secondary" onclick="closeAddProductModal()">Cancel</button>
        <button type="submit" class="btn primary">Add Item</button>
      </div>
    </form>
  </div>
</div>

<div id="editProductModal" class="modal">
  <div class="modal-content">
    <button class="modal-close" onclick="closeEditProductModal()">√ó</button>
    <h3>Edit Service or Product</h3>
    <form id="editProductForm" onsubmit="event.preventDefault(); updateProduct();" class="compact-form">
      <input type="hidden" id="editProductId">
      <input type="text" id="editProductName" placeholder="Service or Product Name" required>
      <div class="form-row">
        <input type="number" id="editProductPrice" placeholder="Price" step="0.01" min="0" required>
        <select id="editProductType">
          <option value="product">Product</option>
          <option value="service">Service</option>
        </select>
      </div>
      <div class="form-row" id="editStockRow">
        <input type="number" id="editProductStock" placeholder="Stock" min="0" required>
        <input type="text" id="editProductThumb" placeholder="Icon Code (2 letters)" maxlength="2" required>
      </div>
      <div class="form-row">
        <select id="editProductTaxCategory" required>
          <option value="">Select VAT Category</option>
          <option value="Standard Rate">Standard Rate (20%)</option>
          <option value="Reduced Rate">Reduced Rate (5%)</option>
          <option value="Zero Rate">Zero Rate (0%)</option>
          <option value="Exempt">Exempt</option>
          <option value="Outside Scope">Outside Scope</option>
        </select>
      </div>
      <div class="modal-buttons">
        <button type="button" class="btn secondary" onclick="closeEditProductModal()">Cancel</button>
        <button type="submit" class="btn primary">Update Item</button>
      </div>
    </form>
  </div>
</div>

<div id="editTransactionModal" class="modal">
  <div class="modal-content">
    <button class="modal-close" onclick="closeEditTransactionModal()">√ó</button>
    <h3>Edit Transaction</h3>
    <form id="editTransactionForm" onsubmit="event.preventDefault(); updateTransaction();" class="compact-form">
      <input type="hidden" id="editTransactionId">
      <div class="form-row">
        <input type="date" id="editTransactionDate" required>
        <select id="editTransactionType">
          <option value="income">Income</option>
          <option value="expense">Expense</option>
        </select>
      </div>
      <div class="form-row">
        <input type="number" id="editTransactionAmount" step="0.01" placeholder="Amount" required>
        <select id="editTransactionTaxCategory" required>
          <option value="">Select VAT Category</option>
          <option value="Standard Rate">Standard Rate (20%)</option>
          <option value="Reduced Rate">Reduced Rate (5%)</option>
          <option value="Zero Rate">Zero Rate (0%)</option>
          <option value="Exempt">Exempt</option>
          <option value="Outside Scope">Outside Scope</option>
        </select>
      </div>
      <input type="text" id="editTransactionDescription" placeholder="Description" required>
      <div class="modal-buttons">
        <button type="button" class="btn secondary" onclick="closeEditTransactionModal()">Cancel</button>
        <button type="submit" class="btn primary">Update Transaction</button>
      </div>
    </form>
  </div>
</div>

<div id="settingsModal" class="modal">
  <div class="modal-content">
    <button class="modal-close" onclick="closeSettingsModal()">√ó</button>
    <h3>Settings</h3>
    <div class="vat-registration-section">
      <h4>VAT Registration</h4>
      <div class="vat-toggle">
        <input type="checkbox" id="vatRegistered">
        <label for="vatRegistered">Business is VAT Registered</label>
      </div>
      <div class="vat-details">
        <div class="vat-threshold-info">
          <strong>VAT Threshold:</strong> ¬£85,000 (current UK threshold)
        </div>
        <div class="vat-threshold-info">
          <strong>Current Turnover:</strong> <span id="currentTurnover">¬£0.00</span>
        </div>
        <div class="vat-threshold-info">
          <strong>Status:</strong> <span id="vatStatus">Below threshold</span>
        </div>
      </div>
    </div>
    <h4>Data Management</h4>
    <div class="form-row">
      <button class="btn secondary" onclick="document.getElementById('dbFileInput').click()" style="flex: 1;">Load Data</button>
      <button class="btn secondary" onclick="backupDB()" style="flex: 1;">Backup Data</button>
    </div>
    <h4>Tax Categories</h4>
    <table class="tax-categories">
      <thead>
        <tr>
          <th>Category</th>
          <th>Rate</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>Standard Rate</td>
          <td><input type="number" id="standardRate" class="tax-rate-input" value="20" min="0" max="100" step="0.1">%</td>
        </tr>
        <tr>
          <td>Reduced Rate</td>
          <td><input type="number" id="reducedRate" class="tax-rate-input" value="5" min="0" max="100" step="0.1">%</td>
        </tr>
        <tr>
          <td>Zero Rate</td>
          <td><input type="number" id="zeroRate" class="tax-rate-input" value="0" min="0" max="100" step="0.1" readonly>%</td>
        </tr>
      </tbody>
    </table>
    <h4>Low Stock Alert</h4>
    <div class="form-row">
      <input type="number" id="lowStockThreshold" placeholder="Low Stock Threshold" min="1" step="1" value="5">
    </div>
    <div class="tax-description">
      Items with stock below this number will be marked with a caution indicator.
    </div>
    <div class="modal-buttons">
      <button type="button" class="btn secondary" onclick="closeSettingsModal()">Cancel</button>
      <button type="button" class="btn primary" onclick="saveSettings()">Save Settings</button>
    </div>
  </div>
</div>

<input type="file" id="dbFileInput" style="display: none;" accept=".json" onchange="loadDBFromFile(event)">

<script>
// ##### DATABASE & INITIALIZATION #####
const DB_KEY = 'PlainCash_life_suite_v2';

function getDefaultDB() {
  return {
    products: [],
    transactions: [],
    settings: { vatRegistered: false, standardRate: 20, reducedRate: 5, zeroRate: 0, lowStockThreshold: 5 }
  };
}

function loadDB() {
  const saved = localStorage.getItem(DB_KEY);
  if (saved) {
    try {
      const parsed = JSON.parse(saved);
      if (!parsed.settings) parsed.settings = getDefaultDB().settings;
      return parsed;
    } catch (e) { console.error('Error loading database:', e); }
  }
  return getDefaultDB();
}

function saveDB(db) {
  localStorage.setItem(DB_KEY, JSON.stringify(db));
}

let db = loadDB();
let cart = [];

function init() {
  renderCatalog(); 
  renderCart(); 
  updateTaxBreakdown(); 
  updateTransactionTimeline(); 
  updateStockCount();
}

// ##### DASHBOARD MANAGEMENT #####
function switchDashboard(dashboardId) {
  document.querySelectorAll('.dashboard').forEach(dashboard => {
    dashboard.classList.remove('active');
  });
  document.getElementById(dashboardId).classList.add('active');
  
  if (dashboardId === 'accountsDashboard') {
    updateTransactionTimeline();
  }
}

function showUserMenu() {
  showNotification('User Menu', 'User profile features coming soon.');
}

// ##### PRODUCT CATALOG FUNCTIONS #####
function renderCatalog() {
  const catalog = document.getElementById('catalog');
  const filter = document.getElementById('filter').value.toLowerCase();
  const filteredProducts = db.products.filter(p => p.name.toLowerCase().includes(filter));
  
  filteredProducts.sort((a, b) => {
    const aLowStock = a.type === 'product' && a.stock < db.settings.lowStockThreshold;
    const bLowStock = b.type === 'product' && b.stock < db.settings.lowStockThreshold;
    return aLowStock === bLowStock ? a.name.localeCompare(b.name) : aLowStock ? -1 : 1;
  });
  
  let html = '';
  filteredProducts.forEach(product => {
    const isLowStock = product.type === 'product' && product.stock < db.settings.lowStockThreshold;
    html += `
      <div class="product ${product.type}" data-id="${product.id}" onclick="addToCart('${product.id}')">
        <div class="thumb">${product.thumb}${isLowStock ? '<div class="low-stock-indicator">‚ö†Ô∏è</div>' : ''}</div>
        <div class="name">${product.name}</div>
        <div class="meta">
          <span>${product.type === 'service' ? 'Service' : `Stock: ${product.stock}`}</span>
          <span class="price">¬£${product.price.toFixed(2)}</span>
        </div>
        <div class="product-menu" onclick="event.stopPropagation(); showProductMenu('${product.id}', event)">
          <div class="product-menu-dots">‚ãÆ</div>
        </div>
      </div>
    `;
  });
  
  html += `<div class="add-product" onclick="showAddProductModal()"><div class="add-thumb">+</div><div class="name">Add New</div></div>`;
  catalog.innerHTML = html;
}

function showProductMenu(productId, event) {
  closeAllMenus();
  const product = db.products.find(p => p.id === productId);
  if (!product) return;
  
  const menu = document.createElement('div');
  menu.className = 'menu-dropdown';
  menu.innerHTML = `
    <div class="menu-item" onclick="editProduct('${product.id}')">Edit</div>
    <div class="menu-item delete" onclick="deleteProduct('${product.id}')">Delete</div>
  `;
  const rect = event.target.getBoundingClientRect();
  menu.style.position = 'fixed';
  menu.style.top = `${rect.bottom + window.scrollY}px`;
  menu.style.left = `${rect.left + window.scrollX}px`;
  document.body.appendChild(menu);
  setTimeout(() => { document.addEventListener('click', closeAllMenus, { once: true }); }, 10);
}

function closeAllMenus() {
  document.querySelectorAll('.menu-dropdown').forEach(menu => menu.remove());
}

// ##### CART MANAGEMENT FUNCTIONS #####
function addToCart(productId) {
  const product = db.products.find(p => p.id === productId);
  if (!product) return;
  if (product.type === 'product' && product.stock <= 0) {
    showNotification('Out of Stock', `${product.name} is out of stock.`);
    return;
  }
  const existingItem = cart.find(item => item.id === productId);
  if (existingItem) existingItem.quantity += 1;
  else cart.push({ id: product.id, name: product.name, price: product.price, type: product.type, taxCategory: product.taxCategory, quantity: 1 });
  renderCart(); updateTaxBreakdown(); showNotification('Added to Cart', `${product.name} added to cart.`);
}

function renderCart() {
  const cartEl = document.getElementById('cart');
  if (cart.length === 0) {
    cartEl.innerHTML = '<div class="small">Cart empty</div>';
    document.getElementById('subtotal').textContent = '¬£0.00';
    document.getElementById('vatTotal').textContent = '¬£0.00';
    document.getElementById('total').textContent = '¬£0.00';
    return;
  }
  
  let html = ''; let subtotal = 0;
  cart.forEach(item => {
    const itemTotal = item.price * item.quantity;
    subtotal += itemTotal;
    html += `
      <div class="cart-item">
        <div class="cart-item-info">
          <div>${item.name} √ó ${item.quantity}</div>
          <div class="small">¬£${itemTotal.toFixed(2)}</div>
        </div>
        <div class="cart-item-actions">
          <button class="btn" onclick="decreaseQuantity('${item.id}')">-</button>
          <button class="btn" onclick="increaseQuantity('${item.id}')">+</button>
          <button class="remove-item" onclick="removeFromCart('${item.id}')">√ó</button>
        </div>
      </div>
    `;
  });
  
  const vatTotal = calculateVATTotal();
  const total = subtotal + vatTotal;
  cartEl.innerHTML = html;
  document.getElementById('subtotal').textContent = `¬£${subtotal.toFixed(2)}`;
  document.getElementById('vatTotal').textContent = `¬£${vatTotal.toFixed(2)}`;
  document.getElementById('total').textContent = `¬£${total.toFixed(2)}`;
}

function calculateVATTotal() {
  let vatTotal = 0;
  cart.forEach(item => {
    const itemTotal = item.price * item.quantity;
    if (item.taxCategory === 'Standard Rate') vatTotal += itemTotal * (db.settings.standardRate / 100);
    else if (item.taxCategory === 'Reduced Rate') vatTotal += itemTotal * (db.settings.reducedRate / 100);
  });
  return vatTotal;
}

function increaseQuantity(productId) {
  const item = cart.find(item => item.id === productId);
  if (item) { item.quantity += 1; renderCart(); updateTaxBreakdown(); }
}

function decreaseQuantity(productId) {
  const item = cart.find(item => item.id === productId);
  if (item && item.quantity > 1) { item.quantity -= 1; renderCart(); updateTaxBreakdown(); }
  else removeFromCart(productId);
}

function removeFromCart(productId) {
  cart = cart.filter(item => item.id !== productId);
  renderCart(); updateTaxBreakdown();
}

function clearCart() {
  cart = []; renderCart(); updateTaxBreakdown();
}

// ##### TAX & FINANCIAL CALCULATIONS #####
function updateTaxBreakdown() {
  let standard = 0, reduced = 0, zero = 0, exempt = 0;
  cart.forEach(item => {
    const itemTotal = item.price * item.quantity;
    switch (item.taxCategory) {
      case 'Standard Rate': standard += itemTotal; break;
      case 'Reduced Rate': reduced += itemTotal; break;
      case 'Zero Rate': zero += itemTotal; break;
      case 'Exempt': exempt += itemTotal; break;
    }
  });
  
  const standardVAT = standard * (db.settings.standardRate / 100);
  const reducedVAT = reduced * (db.settings.reducedRate / 100);
  const totalVAT = standardVAT + reducedVAT;
  
  document.getElementById('vatStandard').textContent = `¬£${standardVAT.toFixed(2)}`;
  document.getElementById('vatReduced').textContent = `¬£${reducedVAT.toFixed(2)}`;
  document.getElementById('vatZero').textContent = `¬£${zero.toFixed(2)}`;
  document.getElementById('vatExempt').textContent = `¬£${exempt.toFixed(2)}`;
  document.getElementById('vatDue').textContent = `¬£${totalVAT.toFixed(2)}`;
  
  updateIncomeTaxOverview();
}

function updateIncomeTaxOverview() {
  let totalIncome = 0, totalExpenses = 0;
  db.transactions.forEach(t => {
    if (t.type === 'income') totalIncome += t.amount;
    else if (t.type === 'expense') totalExpenses += t.amount;
  });
  
  const taxableProfit = Math.max(0, totalIncome - totalExpenses);
  const personalAllowance = 12570;
  const taxableAboveAllowance = Math.max(0, taxableProfit - personalAllowance);
  
  let incomeTax = 0;
  if (taxableAboveAllowance > 0) {
    const basicRateAmount = Math.min(taxableAboveAllowance, 37700);
    incomeTax += basicRateAmount * 0.2;
    const higherRateAmount = Math.max(0, taxableAboveAllowance - 37700);
    incomeTax += higherRateAmount * 0.4;
  }
  
  const niThreshold = 12570;
  const niAmount = Math.max(0, taxableProfit - niThreshold) * 0.09;
  const totalTaxDue = incomeTax + niAmount;
  
  document.getElementById('totalIncome').textContent = `¬£${totalIncome.toFixed(2)}`;
  document.getElementById('totalExpenses').textContent = `¬£${totalExpenses.toFixed(2)}`;
  document.getElementById('taxableProfit').textContent = `¬£${taxableProfit.toFixed(2)}`;
  document.getElementById('incomeTaxDue').textContent = `¬£${incomeTax.toFixed(2)}`;
  document.getElementById('niDue').textContent = `¬£${niAmount.toFixed(2)}`;
  document.getElementById('totalTaxDue').textContent = `¬£${totalTaxDue.toFixed(2)}`;
  
  updateVATStatus(totalIncome);
}

function updateVATStatus(turnover) {
  const threshold = 85000;
  const vatStatus = document.getElementById('vatStatus');
  const currentTurnover = document.getElementById('currentTurnover');
  currentTurnover.textContent = `¬£${turnover.toFixed(2)}`;
  if (turnover >= threshold) {
    vatStatus.textContent = 'Above threshold - must register';
    vatStatus.style.color = 'var(--warning)';
  } else {
    vatStatus.textContent = 'Below threshold';
    vatStatus.style.color = 'var(--success)';
  }
}

// ##### TRANSACTION TIMELINE #####
function updateTransactionTimeline() {
  const timeline = document.getElementById('transactionTimeline');
  const transactions = db.transactions.slice(0, 20);
  
  if (transactions.length === 0) {
    timeline.innerHTML = '<div class="small" style="text-align: center; padding: 40px;">No transactions yet</div>';
    return;
  }
  
  let html = '';
  transactions.forEach(transaction => {
    const isIncome = transaction.type === 'income';
    html += `
      <div class="timeline-item">
        <div class="timeline-icon ${transaction.type}">${isIncome ? '‚Üë' : '‚Üì'}</div>
        <div class="timeline-content">
          <div>${transaction.description}</div>
          <div class="timeline-amount ${transaction.type}">${isIncome ? '+' : '-'}¬£${transaction.amount.toFixed(2)}</div>
          <div class="timeline-date">${transaction.date}</div>
        </div>
        <div class="transaction-actions">
          <button class="btn" onclick="editTransaction('${transaction.id}')">Edit</button>
          <button class="btn danger" onclick="deleteTransaction('${transaction.id}')">Delete</button>
        </div>
      </div>
    `;
  });
  
  timeline.innerHTML = html;
}

// ##### CHECKOUT & TRANSACTIONS #####
function checkout() {
  if (cart.length === 0) { showNotification('Empty Cart', 'Your cart is empty.'); return; }
  
  const transactionDate = new Date().toISOString().split('T')[0];
  cart.forEach(item => {
    const transaction = {
      id: 't' + Date.now() + Math.random(),
      date: transactionDate,
      type: 'income',
      amount: item.price * item.quantity,
      description: item.name,
      taxCategory: item.taxCategory
    };
    db.transactions.unshift(transaction);
    if (item.type === 'product') {
      const product = db.products.find(p => p.id === item.id);
      if (product) product.stock = Math.max(0, product.stock - item.quantity);
    }
  });
  
  saveDB(db); renderCatalog(); updateTransactionTimeline(); updateTaxBreakdown(); updateStockCount();
  showNotification('Sale Recorded', 'Transaction has been recorded successfully.');
  clearCart();
}

function quickAdd() {
  const amount = parseFloat(document.getElementById('q_amount').value);
  const type = document.getElementById('q_type').value;
  const category = document.getElementById('q_cat').value;
  const notes = document.getElementById('q_notes').value;
  
  if (!amount || amount <= 0) { showNotification('Invalid Amount', 'Please enter a valid amount.'); return; }
  if (!category) { showNotification('Category Required', 'Please select a VAT category.'); return; }
  
  const transaction = {
    id: 't' + Date.now() + Math.random(),
    date: new Date().toISOString().split('T')[0],
    type: type,
    amount: amount,
    description: notes || 'Quick Transaction',
    taxCategory: category
  };
  
  db.transactions.unshift(transaction);
  saveDB(db); updateTransactionTimeline(); updateTaxBreakdown();
  document.getElementById('quickForm').reset();
  showNotification('Transaction Added', 'Quick transaction recorded successfully.');
}

function editTransaction(transactionId) {
  const transaction = db.transactions.find(t => t.id === transactionId);
  if (!transaction) return;
  
  document.getElementById('editTransactionId').value = transaction.id;
  document.getElementById('editTransactionDate').value = transaction.date;
  document.getElementById('editTransactionType').value = transaction.type;
  document.getElementById('editTransactionAmount').value = transaction.amount;
  document.getElementById('editTransactionTaxCategory').value = transaction.taxCategory;
  document.getElementById('editTransactionDescription').value = transaction.description;
  
  document.getElementById('editTransactionModal').style.display = 'flex';
}

function closeEditTransactionModal() {
  document.getElementById('editTransactionModal').style.display = 'none';
  document.getElementById('editTransactionForm').reset();
}

function updateTransaction() {
  const transactionId = document.getElementById('editTransactionId').value;
  const transaction = db.transactions.find(t => t.id === transactionId);
  if (!transaction) return;
  
  transaction.date = document.getElementById('editTransactionDate').value;
  transaction.type = document.getElementById('editTransactionType').value;
  transaction.amount = parseFloat(document.getElementById('editTransactionAmount').value);
  transaction.taxCategory = document.getElementById('editTransactionTaxCategory').value;
  transaction.description = document.getElementById('editTransactionDescription').value;
  
  saveDB(db); updateTransactionTimeline(); updateTaxBreakdown(); closeEditTransactionModal();
  showNotification('Transaction Updated', 'Transaction has been updated successfully.');
}

function deleteTransaction(transactionId) {
  if (confirm('Are you sure you want to delete this transaction?')) {
    db.transactions = db.transactions.filter(t => t.id !== transactionId);
    saveDB(db); updateTransactionTimeline(); updateTaxBreakdown();
    showNotification('Transaction Deleted', 'Transaction has been removed.');
  }
}

// ##### PRODUCT MANAGEMENT #####
function showAddProductModal() {
  document.getElementById('addProductModal').style.display = 'flex';
}

function closeAddProductModal() {
  document.getElementById('addProductModal').style.display = 'none';
  document.getElementById('addProductForm').reset();
}

function addNewProduct() {
  const name = document.getElementById('newProductName').value.trim();
  const price = parseFloat(document.getElementById('newProductPrice').value);
  const type = document.getElementById('newProductType').value;
  const stock = type === 'product' ? parseInt(document.getElementById('newProductStock').value) : 0;
  const thumb = document.getElementById('newProductThumb').value.trim().toUpperCase();
  const taxCategory = document.getElementById('newProductTaxCategory').value;
  
  if (!name || !price || price <= 0 || !thumb || !taxCategory) {
    showNotification('Invalid Input', 'Please fill all required fields correctly.');
    return;
  }
  if (type === 'product' && (isNaN(stock) || stock < 0)) {
    showNotification('Invalid Stock', 'Please enter a valid stock quantity.');
    return;
  }
  
  const newProduct = {
    id: 'p' + Date.now(),
    name, price, type,
    stock: type === 'service' ? 999 : stock,
    taxCategory,
    thumb: thumb.substring(0, 2)
  };
  
  db.products.push(newProduct);
  saveDB(db); renderCatalog(); updateStockCount(); closeAddProductModal();
  showNotification('Product Added', `${name} has been added to your catalog.`);
}

function editProduct(productId) {
  const product = db.products.find(p => p.id === productId);
  if (!product) return;
  document.getElementById('editProductId').value = product.id;
  document.getElementById('editProductName').value = product.name;
  document.getElementById('editProductPrice').value = product.price;
  document.getElementById('editProductType').value = product.type;
  document.getElementById('editProductStock').value = product.stock || '';
  document.getElementById('editProductThumb').value = product.thumb;
  document.getElementById('editProductTaxCategory').value = product.taxCategory;
  document.getElementById('editProductModal').style.display = 'flex';
}

function closeEditProductModal() {
  document.getElementById('editProductModal').style.display = 'none';
  document.getElementById('editProductForm').reset();
}

function updateProduct() {
  const productId = document.getElementById('editProductId').value;
  const product = db.products.find(p => p.id === productId);
  if (!product) return;
  
  product.name = document.getElementById('editProductName').value.trim();
  product.price = parseFloat(document.getElementById('editProductPrice').value);
  product.type = document.getElementById('editProductType').value;
  product.stock = product.type === 'product' ? parseInt(document.getElementById('editProductStock').value) : 999;
  product.thumb = document.getElementById('editProductThumb').value.trim().toUpperCase().substring(0, 2);
  product.taxCategory = document.getElementById('editProductTaxCategory').value;
  
  saveDB(db); renderCatalog(); updateStockCount(); closeEditProductModal();
  showNotification('Product Updated', `${product.name} has been updated.`);
}

function deleteProduct(productId) {
  if (confirm('Are you sure you want to delete this item?')) {
    db.products = db.products.filter(p => p.id !== productId);
    saveDB(db); renderCatalog(); updateStockCount();
    showNotification('Product Deleted', 'Item has been removed from your catalog.');
  }
}

function updateStockCount() {
  const totalItems = db.products.filter(p => p.type === 'product').length;
  const lowStockItems = db.products.filter(p => p.type === 'product' && p.stock < db.settings.lowStockThreshold).length;
  document.getElementById('stockCount').textContent = lowStockItems > 0 ? `${lowStockItems} low stock` : `${totalItems} items`;
}

// ##### SETTINGS & UTILITIES #####
function showSettings() {
  document.getElementById('vatRegistered').checked = db.settings.vatRegistered;
  document.getElementById('standardRate').value = db.settings.standardRate;
  document.getElementById('reducedRate').value = db.settings.reducedRate;
  document.getElementById('lowStockThreshold').value = db.settings.lowStockThreshold;
  
  const totalIncome = db.transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
  updateVATStatus(totalIncome);
  document.getElementById('settingsModal').style.display = 'flex';
}

function closeSettingsModal() {
  document.getElementById('settingsModal').style.display = 'none';
}

function saveSettings() {
  db.settings.vatRegistered = document.getElementById('vatRegistered').checked;
  db.settings.standardRate = parseFloat(document.getElementById('standardRate').value);
  db.settings.reducedRate = parseFloat(document.getElementById('reducedRate').value);
  db.settings.lowStockThreshold = parseInt(document.getElementById('lowStockThreshold').value);
  saveDB(db); renderCatalog(); updateTaxBreakdown(); closeSettingsModal();
  showNotification('Settings Saved', 'Your settings have been updated.');
}

function showAnalytics() {
  const totalIncome = db.transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
  const totalExpenses = db.transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
  
  const analyticsModal = document.createElement('div');
  analyticsModal.className = 'modal';
  analyticsModal.style.display = 'flex';
  analyticsModal.innerHTML = `
    <div class="modal-content">
      <button class="modal-close" onclick="this.parentElement.parentElement.remove()">√ó</button>
      <h3>Business Analytics</h3>
      <div class="analytics-container">
        <div class="analytics-chart">
          <div style="text-align: center; color: var(--text-tertiary);">
            <div style="font-size: 48px; margin-bottom: 8px;">üìä</div>
            <div>Analytics Dashboard</div>
            <div style="font-size: 15px; margin-top: 4px;">Income: ¬£${totalIncome.toFixed(2)} | Expenses: ¬£${totalExpenses.toFixed(2)}</div>
          </div>
        </div>
        <div class="analytics-stats">
          <div class="stat-card"><div class="stat-value">¬£${totalIncome.toFixed(2)}</div><div class="stat-label">Total Income</div></div>
          <div class="stat-card"><div class="stat-value">¬£${totalExpenses.toFixed(2)}</div><div class="stat-label">Total Expenses</div></div>
          <div class="stat-card"><div class="stat-value">¬£${(totalIncome - totalExpenses).toFixed(2)}</div><div class="stat-label">Net Profit</div></div>
          <div class="stat-card"><div class="stat-value">¬£${calculateVATTotal().toFixed(2)}</div><div class="stat-label">VAT Due</div></div>
        </div>
      </div>
      <div class="modal-buttons">
        <button type="button" class="btn secondary" onclick="this.closest('.modal').remove()">Close</button>
      </div>
    </div>
  `;
  document.body.appendChild(analyticsModal);
}

function backupDB() {
  const dataStr = JSON.stringify(db, null, 2);
  const dataBlob = new Blob([dataStr], { type: 'application/json' });
  const url = URL.createObjectURL(dataBlob);
  const link = document.createElement('a');
  link.href = url;
  link.download = `PlainCash-backup-${new Date().toISOString().split('T')[0]}.json`;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(url);
  showNotification('Backup Created', 'Your data has been backed up.');
}

function loadDBFromFile(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const loadedDB = JSON.parse(e.target.result);
      if (!loadedDB.settings) loadedDB.settings = getDefaultDB().settings;
      db = loadedDB;
      saveDB(db);
      renderCatalog(); renderCart(); updateTaxBreakdown(); updateTransactionTimeline(); updateStockCount();
      showNotification('Database Loaded', 'Your data has been loaded successfully.');
    } catch (error) {
      showNotification('Load Error', 'Failed to load database file.');
      console.error(error);
    }
  };
  reader.readAsText(file);
  event.target.value = '';
}

function exportHMRCReport() {
  const incomeTransactions = db.transactions.filter(t => t.type === 'income');
  const expenseTransactions = db.transactions.filter(t => t.type === 'expense');
  
  let csvContent = "HMRC Report - Self Assessment\n\nINCOME\nDate,Description,Amount,VAT Category\n";
  incomeTransactions.forEach(t => { csvContent += `${t.date},"${t.description}",${t.amount},"${t.taxCategory}"\n`; });
  
  csvContent += "\nEXPENSES\nDate,Description,Amount,VAT Category\n";
  expenseTransactions.forEach(t => { csvContent += `${t.date},"${t.description}",${t.amount},"${t.taxCategory}"\n`; });
  
  if (db.settings.vatRegistered) {
    csvContent += "\nVAT SUMMARY\nCategory,Net Amount,VAT Amount\n";
    const vatByCategory = {};
    incomeTransactions.forEach(t => {
      if (!vatByCategory[t.taxCategory]) vatByCategory[t.taxCategory] = { net: 0, vat: 0 };
      vatByCategory[t.taxCategory].net += t.amount;
      if (t.taxCategory === 'Standard Rate') vatByCategory[t.taxCategory].vat += t.amount * (db.settings.standardRate / 100);
      else if (t.taxCategory === 'Reduced Rate') vatByCategory[t.taxCategory].vat += t.amount * (db.settings.reducedRate / 100);
    });
    Object.entries(vatByCategory).forEach(([category, amounts]) => {
      if (amounts.vat > 0) csvContent += `"${category}",${amounts.net.toFixed(2)},${amounts.vat.toFixed(2)}\n`;
    });
  }
  
  const totalIncome = incomeTransactions.reduce((sum, t) => sum + t.amount, 0);
  const totalExpenses = expenseTransactions.reduce((sum, t) => sum + t.amount, 0);
  const netProfit = totalIncome - totalExpenses;
  csvContent += "\nSUMMARY\n";
  csvContent += `Total Income,${totalIncome.toFixed(2)}\n`;
  csvContent += `Total Expenses,${totalExpenses.toFixed(2)}\n`;
  csvContent += `Net Profit,${netProfit.toFixed(2)}\n`;
  
  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const link = document.createElement('a');
  link.href = url;
  link.download = `hmrc-report-${new Date().toISOString().split('T')[0]}.csv`;
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  URL.revokeObjectURL(url);
  showNotification('Report Exported', 'HMRC report has been generated and downloaded.');
}

function showNotification(title, message) {
  document.querySelectorAll('.notification').forEach(n => n.remove());
  const notification = document.createElement('div');
  notification.className = 'notification';
  notification.innerHTML = `
    <div class="notification-icon">üí°</div>
    <div class="notification-content">
      <div class="notification-title">${title}</div>
      <div class="notification-message">${message}</div>
    </div>
    <button class="notification-close" onclick="this.parentElement.remove()">√ó</button>
  `;
  document.body.appendChild(notification);
  setTimeout(() => { if (notification.parentElement) notification.remove(); }, 5000);
}

// ##### INITIALIZATION #####
window.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>